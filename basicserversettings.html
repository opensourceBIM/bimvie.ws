<div class="basicserversettings">
	<form class="form-horizontal" role="form">
		<div class="panel panel-default">
			<div class="panel-heading">Main server settings</div>
			<div class="panel-body">
				<div class="form-group">
					<label class="col-sm-2 control-label" for="siteAddress"><a rel="tooltip" data-original-title="Address where this BIMserver can primarily be found. Make sure you add a port number if the server is not running on port 80. Also include http:// or https://" data-placement="right">Site address</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control siteAddress" id="siteAddress" placeholder="Name">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="serverName"><a rel="tooltip" data-original-title="" data-placement="right">Server name</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control serverName" id="serverName" placeholder="Server Name">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="serverDescription"><a rel="tooltip" data-original-title="" data-placement="right">Site description</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control serverDescription" id="serverDescription" placeholder="Server Description">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="serverIcon"><a rel="tooltip" data-original-title="" data-placement="right">Server icon</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control serverIcon" id="serverIcon" placeholder="Server Icon">
					</div>
				</div>
			</div>
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">Other settings</div>
			<div class="panel-body">
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label for="hideUserList">
								<input type="checkbox" class="hideUserList" id="hideUserList">
								<a rel="tooltip" data-original-title="Whether to hide the list of users for non-admin users" data-placement="right">Hide userlist for non-admin users</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="checkinMergingEnabled">
								<a rel="tooltip" data-original-title="Whether checkin-merging is enabled" data-placement="right">Checkin merging enabled</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="storeLastLogin">
								<a rel="tooltip" data-original-title="Whether to update last-login for User on login" data-placement="right">Update last-login on login</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="storeServiceRuns">
								<a rel="tooltip" data-original-title="Whether to store the models sent for running a service" data-placement="right">Store service runs</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="createTopLevelProjects">
								<a rel="tooltip" data-original-title="Allow user to create top level projects" data-placement="right">Allow user to create top level projects</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="allowSelfRegistration"/>
								<a rel="tooltip" data-original-title="Whether to allow users to register themselves" data-placement="right">Allow self registration</a>
							</label>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="panel panel-default">
  			<div class="panel-heading">Geometry generation</div>
  				<div class="panel-body">
					<div class="form-group">
						<div class="col-sm-offset-2 col-sm-10">
							<div class="checkbox">
								<label>
									<input type="checkbox" class="generateGeometryCheckin">
									<a rel="tooltip" data-original-title="Whether to generate geometry on checkin" data-placement="right">Generate geometry on checkin</a>
								</label>
							</div>
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-2 col-sm-10">
							<div class="checkbox">
								<label>
									<input type="checkbox" class="geometryReuseEnabled">
									<a rel="tooltip" data-original-title="Whether geometry reuse is enabled" data-placement="right">Geometry reuse</a>
								</label>
							</div>
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-2 col-sm-10">
							<div class="checkbox">
								<label>
									<input type="checkbox" class="geometryOptimizeMappedItems">
									<a rel="tooltip" data-original-title="Optimize mapped item geometry" data-placement="right">Optimize mapped items (more reuse)</a>
								</label>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-sm-2"><a rel="tooltip" data-original-title="Maximum amount of processes to use concurrently when generating geometry for 1 revision" data-placement="right">Max Render Engine Processes</a>
						</label>
						<div class="col-sm-8">
							<input type="text" class="form-control renderEngineProcesses">
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label" for="defaultRenderEnginePlugin"><a rel="tooltip" data-original-title="Default render engine plugin" data-placement="right">Default render engine plugin</a></label>
						<div class="col-sm-8">
							<select class="form-control defaultRenderEnginePlugin" id="defaultRenderEnginePlugin">
							</select>
						</div>
					</div>
				</div>
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">Email</div>
			<div class="panel-body">
				<div class="form-group">
					<label class="col-sm-2 control-label" for="smtpServer"><a rel="tooltip" data-original-title="SMTP server to use for sending emails" data-placement="right">SMTP server</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control smtpServer" id="smtpServer" placeholder="Name">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="smtpUsername"><a rel="tooltip" data-original-title="SMTP username" data-placement="right">SMTP username</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control smtpUsername" id="smtpUsername" placeholder="SMTP username">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="smtpPassword"><a rel="tooltip" data-original-title="SMTP password" data-placement="right">SMTP password</a></label>
					<div class="col-sm-8">
						<input type="password" class="form-control smtpPassword" id="smtpPassword" placeholder="SMTP password">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="smtpPort"><a rel="tooltip" data-original-title="SMTP port" data-placement="right">SMTP port</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control smtpPort" id="smtpPort" placeholder="SMTP port">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="smtpProtocol"><a rel="tooltip" data-original-title="SMTP protocol" data-placement="right">SMTP protocol</a></label>
					<div class="col-sm-8">
						<select class="form-control smtpProtocol" id="smtpProtocol">
							<option value="SMTP">SMTP</option>
							<option value="SMTPS">SMTPS</option>
							<option value="STARTTLS">STARTTLS</option>
						</select>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="emailSenderAddress"><a rel="tooltip" data-original-title="Email address to send emails from" data-placement="right">Email sender address</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control emailSenderAddress" id="emailSenderAddress" placeholder="Name">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="emailSenderName"><a rel="tooltip" data-original-title="Name to use for sending emails" data-placement="right">Email sender name</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control emailSenderName" id="emailSenderName" placeholder="Name">
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="sendConfirmationEmailAfterRegistration"/>
								<a rel="tooltip" data-original-title="Whether a confirmation e-mail should be send after a new user has been registered" data-placement="right">Send confirmation email after registration</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="sendEmailOnNewRevision"/>
								<a rel="tooltip" data-original-title="Whether an email should be send to all authorized users of a project when there is new revision" data-placement="right">Send email on new revision</a>
							</label>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">Technical</div>
			<div class="panel-body">
				<div class="form-group">
					<label class="col-sm-2 control-label" for="inputRepositoryServer"><a rel="tooltip" data-original-title="Central repository server from which services, plugins and extended data schemas can be loaded" data-placement="right">Repository Server</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control inputRepositoryServer" id="inputRepositoryServer" placeholder="Name">
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="strictPluginChecking">
								<a rel="tooltip" data-original-title="Only allow to install plugins that indicate to work with this version of BIMserver" data-placement="right">Strict plugin checking</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<button class="btn btn-default clearMavenCacheButton">Clear maven cache</button>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="input-xxlarge cacheOutputFiles">
								<a rel="tooltip" data-original-title="Whether serialized versions of models should be cached on disk. The first time a model is downloaded a cache file will be created. The server administrator is responsible for cleaning up cached files" data-placement="right">Cache output files</a>
							</label>
						</div>
						<button class="btn btn-default clearCacheButton">Clear cache</button>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="protocolBuffersPort"><a rel="tooltip" data-original-title="Port to run the protocol buffers server on" data-placement="right">Protocol buffers port</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control protocolBuffersPort" id="protocolBuffersPort">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label" for="sessionTimeOutSeconds"><a rel="tooltip" data-original-title="Session timeout in seconds" data-placement="right">Session timeout (s)</a></label>
					<div class="col-sm-8">
						<input type="text" class="form-control sessionTimeOutSeconds" id="sessionTimeOutSeconds">
					</div>
				</div>
			</div>
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">Security</div>
			<div class="panel-body">
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="checkbox">
							<label>
								<input type="checkbox" class="allowOnlyWhitelisted"/>
								<a rel="tooltip" data-original-title="Whether only whitelisted (below) domains should be authorized to connect" data-placement="right">Only white listed domains</a>
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label"><a rel="tooltip" data-original-title="Select from which referred domains web browsers can connect to this BIMserver. More information about this can be found by searching for 'CORS'" data-placement="right">Whitelisted domains</a></label>
					<div class="col-sm-8 whiteListedDomains">
					</div>
				</div>
			</div>
		</div>
	</form>
</div>
<script>
function BasicServerSettings(main, serversettings) {
	var othis = this;
	othis.change = false;
	
	this.show = function(){};
	
	this.removeDomainButton = function(){
		$(this).parent().remove();		
		othis.change = true;
		othis.save();
	};

	this.checkWhiteListedDomains = function() {
		othis.change = true;
		var empty = 0;
		$(".basicserversettings .whiteListedDomainDiv").each(function(){
			if ($(this).find(".whiteListedDomain").val() == "") {
				empty++;
				$(this).find("button").hide();
			} else {
				$(this).find("button").show();
			}
		});
		if (empty == 0) {
			othis.addWhiteListedDomain("");
		} else if (empty > 1) {
			var found = 0;
			$(".basicserversettings .whiteListedDomainDiv").each(function(){
				if ($(this).find(".whiteListedDomain").val() == "") {
					found++;
					if (found > 1) {
						$(this).remove();
					}
				}
			});
		}
	};
	
	this.save = function(force) {
		if (othis.change) {
			var serverSettings = {
				__type: "SServerSettings"
			};
			serverSettings.whitelistedDomains = [];
			$(".basicserversettings .whiteListedDomainDiv").each(function(){
				var val = $(this).find("input").val();
				if (val != "") {
					serverSettings.whitelistedDomains.push(val);
				}
			});
			serverSettings.serviceRepositoryUrl = $(".basicserversettings .inputRepositoryServer").val();
			serverSettings.siteAddress = $(".basicserversettings .siteAddress").val();
			serverSettings.name = $(".basicserversettings .serverName").val();
			serverSettings.description = $(".basicserversettings .serverDescription").val();
			serverSettings.icon = $(".basicserversettings .serverIcon").val();
			serverSettings.smtpServer = $(".basicserversettings .smtpServer").val();
			serverSettings.smtpProtocol = $(".basicserversettings .smtpProtocol").val();
			serverSettings.smtpPort = $(".basicserversettings .smtpPort").val();
			serverSettings.smtpUsername = $(".basicserversettings .smtpUsername").val();
			serverSettings.smtpPassword = $(".basicserversettings .smtpPassword").val();
			serverSettings.emailSenderAddress = $(".basicserversettings .emailSenderAddress").val();
			serverSettings.emailSenderName = $(".basicserversettings .emailSenderName").val();
			serverSettings.hideUserListForNonAdmin = $(".basicserversettings .hideUserList").prop("checked");
			serverSettings.protocolBuffersPort = $(".basicserversettings .protocolBuffersPort").val();
			serverSettings.sessionTimeOutSeconds = $(".basicserversettings .sessionTimeOutSeconds").val();
			serverSettings.cacheOutputFiles = $(".basicserversettings .cacheOutputFiles").prop("checked");
			serverSettings.defaultRenderEnginePluginId = $(".basicserversettings .defaultRenderEnginePlugin").val();
			serverSettings.renderEngineProcesses = $(".basicserversettings .renderEngineProcesses").val();
			serverSettings.reuseGeometry = $(".basicserversettings .geometryReuseEnabled").prop("checked");
			serverSettings.optimizeMappedItems = $(".basicserversettings .geometryOptimizeMappedItems").prop("checked");
			serverSettings.checkinMergingEnabled = $(".basicserversettings .checkinMergingEnabled").prop("checked");
			serverSettings.storeLastLogin = $(".basicserversettings .storeLastLogin").prop("checked");
			serverSettings.storeServiceRuns = $(".basicserversettings .storeServiceRuns").prop("checked");
			serverSettings.allowUsersToCreateTopLevelProjects = $(".basicserversettings .createTopLevelProjects").prop("checked");
			serverSettings.allowSelfRegistration = $(".basicserversettings .allowSelfRegistration").prop("checked");
			serverSettings.sendConfirmationEmailAfterRegistration = $(".basicserversettings .sendConfirmationEmailAfterRegistration").prop("checked");
			serverSettings.sendEmailOnNewRevision = $(".basicserversettings .sendEmailOnNewRevision").prop("checked");
			serverSettings.allowOnlyWhitelisted = $(".basicserversettings .allowOnlyWhitelisted").prop("checked");
			serverSettings.pluginStrictVersionChecking = $(".basicserversettings .strictPluginChecking").prop("checked");
			serverSettings.generateGeometryOnCheckin = $(".basicserversettings .generateGeometryCheckin").prop("checked");
			Global.bimServerApi.callWithFullIndication("SettingsInterface", "setServerSettings", {serverSettings: serverSettings}, function(data){
				othis.change = false;
			});
		}
	};

	this.addWhiteListedDomain = function(domain) {
		var div = $("<div class=\"whiteListedDomainDiv\">");
		var input = $("<input type=\"text\" class=\"form-control whiteListedDomain input-xlarge\">");
		input.val(domain);
		if (domain == "") {
			input.attr("placeHolder", "Add a new domain");
		}
		var button = $("<button class=\"btn btn-small removeDomainButton\"><i class=\"icon-minus\"/></button>");
		button.attr("title", "Remove domain");
		button.click(othis.removeDomainButton);
		div.append(input);
		input.blur(othis.save);
		input.keyup(othis.checkWhiteListedDomains);
		div.append(button);
		if (domain == "") {
			button.hide();
		}
		$(".basicserversettings .whiteListedDomains").append(div);
	};
	
	this.loadSettings = function() {
		Global.bimServerApi.call("SettingsInterface", "getServerSettings", {}, function(data){
			$(".basicserversettings .inputRepositoryServer").val(data.serviceRepositoryUrl);
			$(".basicserversettings .siteAddress").val(data.siteAddress);
			$(".basicserversettings .serverName").val(data.name);
			$(".basicserversettings .serverDescription").val(data.description);
			$(".basicserversettings .serverIcon").val(data.icon);
			$(".basicserversettings .smtpServer").val(data.smtpServer);
			$(".basicserversettings .smtpUsername").val(data.smtpUsername);
			$(".basicserversettings .smtpPassword").val(data.smtpPassword);
			$(".basicserversettings .smtpPort").val(data.smtpPort);
			$(".basicserversettings .smtpProtocol").val(data.smtpProtocol);
			$(".basicserversettings .emailSenderAddress").val(data.emailSenderAddress);
			$(".basicserversettings .emailSenderName").val(data.emailSenderName);
			$(".basicserversettings .hideUserList").prop("checked", data.hideUserListForNonAdmin);
			$(".basicserversettings .protocolBuffersPort").val(data.protocolBuffersPort);
			$(".basicserversettings .renderEngineProcesses").val(data.renderEngineProcesses);
			$(".basicserversettings .sessionTimeOutSeconds").val(data.sessionTimeOutSeconds);
			$(".basicserversettings .cacheOutputFiles").prop("checked", data.cacheOutputFiles);
			$(".basicserversettings .geometryReuseEnabled").prop("checked", data.reuseGeometry);
			$(".basicserversettings .geometryOptimizeMappedItems").prop("checked", data.optimizeMappedItems);
			$(".basicserversettings .checkinMergingEnabled").prop("checked", data.checkinMergingEnabled);
			$(".basicserversettings .createTopLevelProjects").prop("checked", data.allowUsersToCreateTopLevelProjects);
			$(".basicserversettings .storeLastLogin").prop("checked", data.storeLastLogin);
			$(".basicserversettings .storeServiceRuns").prop("checked", data.storeServiceRuns);
			$(".basicserversettings .allowSelfRegistration").prop("checked", data.allowSelfRegistration);
			$(".basicserversettings .sendConfirmationEmailAfterRegistration").prop("checked", data.sendConfirmationEmailAfterRegistration);
			$(".basicserversettings .sendEmailOnNewRevision").prop("checked", data.sendEmailOnNewRevision);
			$(".basicserversettings .allowOnlyWhitelisted").prop("checked", data.allowOnlyWhitelisted);
			$(".basicserversettings .generateGeometryCheckin").prop("checked", data.generateGeometryOnCheckin);
			$(".basicserversettings .strictPluginChecking").prop("checked", data.pluginStrictVersionChecking);
			$(".basicserversettings .whiteListedDomains .whiteListedDomainDiv").remove();
			data.whitelistedDomains.forEach(function(domain){
				othis.addWhiteListedDomain(domain);
			});
			othis.addWhiteListedDomain("");
			othis.updateWhiteListedVisible(data.allowOnlyWhitelisted);
		});
	};
	
	this.updateWhiteListedVisible = function(allowOnlyWhitelisted){
		if (allowOnlyWhitelisted) {
			$(".basicserversettings .whiteListedDomains input").removeAttr("disabled");
			$(".basicserversettings .whiteListedDomains button").show();
			$(".basicserversettings .whiteListedDomains input").each(function(){
				if ($(this).val() == "") {
					$(this).show();
				}
			});
		} else {
			$(".basicserversettings .whiteListedDomains input").attr("disabled", "disabled");
			$(".basicserversettings .whiteListedDomains button").hide();
			$(".basicserversettings .whiteListedDomains input").each(function(){
				if ($(this).val() == "") {
					$(this).hide();
				}
			});
		}
	};
	
	this.clearCacheClick = function(event){
		event.preventDefault();
		Global.bimServerApi.call("AdminInterface", "clearOutputFileCache", {}, function(data){
			alert(data + " cache files removed");
		});
	};

	this.clearMavenCacheClick = function(event){
		event.preventDefault();
		Global.bimServerApi.call("PluginInterface", "clearMavenCache", {}, function(data){
		});
	};
	
	this.close = function(){
	};
	
	$(".basicserversettings select").change(function(){othis.change = true; othis.save()});
	$(".basicserversettings input[type='checkbox']").change(function(){othis.change = true; othis.save()});
	$(".basicserversettings input[type='text'], .basicserversettings input[type='password']").blur(othis.save);
	$(".basicserversettings input[type='text'], .basicserversettings input[type='password']").enterpress(othis.save);
	$(".basicserversettings input[type='text'], .basicserversettings input[type='password']").keyup(function(event){
		if (event.which != 13 && event.which != 9) {
			othis.change = true;
		}
	});
	$(".basicserversettings .allowOnlyWhitelisted").change(function(event){othis.updateWhiteListedVisible($(this).is(":checked"))});
	$(".basicserversettings .clearCacheButton").click(othis.clearCacheClick);
	$(".basicserversettings .clearMavenCacheButton").click(othis.clearMavenCacheClick);

	Global.bimServerApi.call("PluginInterface", "getDefaultRenderEnginePluginDescriptor", {}, function(defaultPluginDescriptor){
		Global.bimServerApi.call("PluginInterface", "getAllRenderEnginePluginDescriptors", {}, function(pluginDescriptors){
			pluginDescriptors.forEach(function(pluginDescriptor){
				var option = $("<option value=\"" + pluginDescriptor.oid + "\">" + pluginDescriptor.name + "</option>");
				$(".defaultRenderEnginePlugin").append(option);
				if (defaultPluginDescriptor.oid == pluginDescriptor.oid) {
					option.attr("selected", "selected");
				}
			});
		});
	});
	
	$("[rel=tooltip]").tooltip();
	othis.loadSettings();
}
</script>